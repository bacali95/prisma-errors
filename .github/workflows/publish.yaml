name: Publish library

on:
  push:
    branches:
      - main

concurrency: ${{ github.ref }}
permissions:
  contents: read # for checkout

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # to be able to publish a GitHub release
      issues: write # to be able to comment on released issues
      pull-requests: write # to be able to comment on released pull requests
      id-token: write # to enable use of OIDC for npm provenance
    steps:
      - name: Check out the code ðŸ—„
        uses: actions/checkout@v4

      - uses: ./.github/actions/setup-environment

      - name: Lint the code ðŸ•µ
        run: yarn lint prisma-errors-core

      - name: Check the prettiness of the code ðŸ’…
        run: yarn prettier:check

      - name: Run unit tests ðŸ§ª
        run: yarn test prisma-errors-core

      - name: Build code ðŸ› 
        run: yarn build prisma-errors-core

      - name: Publish the library ðŸš€
        run: |
          cp LICENCE README.md dist/libs/prisma-errors-core
          cd dist/libs/prisma-errors-core
          npx semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}
